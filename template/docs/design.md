# SQL助手设计文档

本文档详细说明SQL助手命令行工具的设计思路、系统架构和实现细节。

## 设计目标

SQL助手旨在满足《计算机学报》Project 2025 题目一的要求，提供以下功能：

1. **数据库管理**：初始化、创建数据库和导入关系模式
2. **SQL检查**：分析SQL语句的语法正确性，提供用户友好的错误信息和修改建议
3. **查询可视化**：直观展示查询计划和查询结果
4. **自然语言查询**：将自然语言转换为SQL查询
5. **系统重置**：清除数据库以便重新开始

## 系统架构

系统采用模块化设计，按功能划分为以下核心组件：

```
sqlassistant/
│
├── cli.py           # 命令行接口
├── db.py            # 数据库管理模块
├── parser.py        # SQL解析与检查模块
├── visualizer.py    # 查询可视化模块
├── nlp.py           # 自然语言处理模块
└── utils.py         # 工具函数
```

### 数据流程图

```
用户输入 -> 命令行接口(cli.py) -> 各功能模块 -> 输出结果
                    │
                    ├── 数据库管理(db.py)
                    ├── SQL解析(parser.py)
                    ├── 查询可视化(visualizer.py)
                    └── 自然语言处理(nlp.py)
```

## 核心模块设计

### 1. 命令行接口 (cli.py)

**功能职责**:
- 提供用户友好的命令行界面
- 解析命令行参数，调用相应模块处理请求
- 格式化并输出操作结果

**设计原则**:
- 使用Typer库构建直观、易用的命令行界面
- 提供详细的帮助信息和命令文档
- 使用Rich库实现丰富的终端输出格式

**主要命令**:
- `init`: 初始化数据库
- `schema`: 管理数据库模式
- `check`: 检查SQL语句
- `query`: 执行查询并可视化
- `nlquery`: 自然语言查询
- `reset`: 重置系统

### 2. 数据库管理 (db.py)

**功能职责**:
- 处理数据库连接与初始化
- 执行SQL查询
- 导入和管理数据库模式
- 提供数据库元数据信息

**设计原则**:
- 采用SQLAlchemy作为数据库抽象层，支持多种数据库后端
- 主要针对PostgreSQL进行优化
- 使用事务确保数据库操作的原子性
- 提供详细的错误处理和日志记录

**关键接口**:
- `initialize_database()`: 创建并初始化数据库
- `import_schema()`: 导入数据库模式
- `execute_query()`: 执行SQL查询并返回结果
- `get_all_schema_info()`: 获取数据库模式元数据

### 3. SQL解析器 (parser.py)

**功能职责**:
- 检查SQL语句的语法正确性
- 提供友好的错误信息
- 根据错误类型生成修改建议
- 检查常见的SQL逻辑错误

**设计原则**:
- 使用sqlparse和sqlglot库进行SQL解析
- 针对不同类型的错误提供特定的修改建议
- 支持多种SQL方言，特别是PostgreSQL
- 实现编辑距离算法用于拼写检查

**关键实现**:
- 词法分析与语法分析相结合的检查方法
- 错误消息本地化与友好化处理
- 基于常见错误模式的启发式检查

### 4. 查询可视化 (visualizer.py)

**功能职责**:
- 可视化SQL查询结果
- 自动选择合适的可视化类型
- 显示查询执行计划
- 支持多种输出格式

**设计原则**:
- 根据查询类型和结果数据特征自动选择可视化方式
- 支持matplotlib和plotly两种渲染引擎
- 提供直观、美观的图表和表格展示
- 允许将可视化结果导出为图片

**可视化类型**:
- 聚合分析：柱状图、饼图、热图
- 时间序列：线图、面积图
- 多表关联：散点图、相关性矩阵
- 查询计划：树状图

### 5. 自然语言处理 (nlp.py)

**功能职责**:
- 将自然语言查询转换为SQL
- 集成本地或在线大型语言模型
- 在提示中注入数据库模式信息
- 提取和格式化生成的SQL

**设计原则**:
- 优先使用Hugging Face本地模型
- 支持阿里云Qwen和DeepSeek在线API
- 使用精心设计的提示工程提高转换质量
- 针对PostgreSQL语法优化输出

**实现细节**:
- 根据系统资源动态调整模型加载策略
- 提供详细的模型状态和错误报告
- 支持模型参数自定义（temperature、max_tokens等）

### 6. 工具函数 (utils.py)

**功能职责**:
- 配置文件加载与处理
- 日志记录配置
- 通用辅助函数

**设计原则**:
- 集中管理配置和环境变量
- 提供统一的错误处理机制
- 简化常用操作的代码复用

## 配置管理

系统采用YAML格式的配置文件（config.yaml），包含以下主要配置项：

1. **数据库设置**：
   - 数据库类型（PostgreSQL为主）
   - 连接参数（主机、端口、用户名等）

2. **SQL解析器设置**：
   - 错误格式（友好、技术、详细）
   - 是否提供修改建议
   - SQL方言

3. **可视化设置**：
   - 渲染引擎选择
   - 主题配置
   - 查询计划显示控制

4. **自然语言处理设置**：
   - 模型类型（本地/在线）
   - 本地模型路径和参数
   - API提供商和密钥配置

5. **日志设置**：
   - 日志级别
   - 日志文件路径

## 关键设计决策

1. **PostgreSQL优先**：
   系统默认并优化了对PostgreSQL的支持，因为它功能完善，广泛应用于学术和企业环境。

2. **模块化设计**：
   通过明确的模块边界和接口，使系统易于理解、测试和扩展。

3. **本地LLM优先**：
   为了保护隐私和降低依赖，系统优先使用本地Hugging Face模型，同时提供在线API作为备选。

4. **智能可视化**：
   系统能够根据查询类型和数据特征自动选择最合适的可视化方式，无需用户指定。

5. **友好错误处理**：
   所有错误消息都经过处理，以提供用户友好、有帮助的反馈，并尽可能给出修复建议。

## 扩展性考虑

系统设计考虑了以下扩展方向：

1. **数据库支持**：
   虽然优先支持PostgreSQL，但架构允许轻松添加其他数据库后端支持。

2. **LLM模型**：
   系统使用抽象接口设计，可以方便地集成新的本地或在线LLM模型。

3. **可视化类型**：
   可视化模块使用策略模式，便于添加新的可视化类型。

4. **语言支持**：
   系统设计考虑了国际化，可以扩展到支持多语言错误消息和界面。

## 技术债务与限制

当前版本存在以下限制，作为未来改进的方向：

1. **性能考虑**：
   对于大型数据集，系统性能可能受限，未来可考虑增加分页和异步处理。

2. **LLM依赖**：
   自然语言处理高度依赖LLM质量，需要持续优化提示工程和考虑模型微调。

3. **测试覆盖**：
   当前版本需要更全面的测试套件，特别是针对边缘情况的测试。

## 结论

SQL助手采用模块化、可扩展的设计，专注于提供友好的用户体验和高质量的SQL辅助功能。系统针对PostgreSQL进行了优化，同时通过抽象设计保持了对其他数据库的支持可能性。自然语言处理功能优先使用本地Hugging Face模型，在资源受限时可切换到在线API。 